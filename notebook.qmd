---
title: "Educational Notebook"
subtitle: "Citizen Science and STEM Education with R ‚Äî AI‚ÄìIoT Forecasting and Reproducible Learning from Open Urban Air Quality Data"
author:
  - name: "Jes√∫s C√°ceres Tello"
    affiliation: "Universidad Complutense de Madrid"
    email: "jcaceres.academic@gmail.com"
  - name: "Jos√© Javier Gal√°n Hern√°ndez"
    affiliation: "Universidad Complutense de Madrid"
date: "2025"
lang: en
bibliography: ../applsci-3979500.bib
link-citations: true
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: true
    theme: cosmo
---

## üåç Introduction

This notebook complements the article *Citizen Science and STEM Education with R: AI‚ÄìIoT Forecasting and Reproducible Learning from Open Urban Air Quality Data*\
(Applied Sciences, 2025) and includes reproducible code examples, data harmonisation workflows, and visualisations.

It reproduces the main analytical workflow implemented in the study and illustrates how R and Quarto can be integrated into **STEM education** to foster data literacy, environmental awareness, and methodological transparency.

------------------------------------------------------------------------

# üîÅ Reproducible Data Workflow

The complete workflow integrates **open data**, **computational reproducibility**, and **STEM learning**.\
It can be applied to other urban contexts or courses focusing on environmental informatics, statistical modelling, or sustainability transitions.

```{r fig1-pipeline, echo=FALSE, fig.align='center', out.width='90%', fig.cap='Fig. 1. Open Data and Methodological Pipeline.'}
knitr::include_graphics("images/Fig1_Open_Data_and_Methodological_Pipeline.png")

```

------------------------------------------------------------------------

# üóÇÔ∏èÔ∏è Data Sources and Structure

## Air Quality Data

Air quality datasets were retrieved from the **Madrid Open Data Portal** (*Portal de Datos Abiertos del Ayuntamiento de Madrid*).\
Measurements include nitrogen dioxide (NO‚ÇÇ), ozone (O‚ÇÉ), particulate matter (PM‚ÇÅ‚ÇÄ, PM‚ÇÇ.‚ÇÖ), sulphur dioxide (SO‚ÇÇ), and carbon monoxide (CO) recorded hourly across 24 urban stations (2020‚Äì2024).

```{r fig2a-map, echo=FALSE, fig.align='center', out.width='90%', fig.cap='Fig. 2a. Air quality monitoring stations across the Madrid urban area (2020‚Äì2024).'}
knitr::include_graphics("images/Fig2a_Mapa_Madrid_Final_v7_3.png")

```

## Pollutant Coverage

Each station has different pollutant coverage and measurement frequency, which provides an excellent example for students to explore data completeness and measurement uncertainty in open environmental datasets.

```{r fig2b-coverage, echo=FALSE, fig.align='center', out.width='90%', fig.cap='Fig. 2b. Pollutant coverage and measurement frequency across monitoring stations.'}
knitr::include_graphics("images/Fig2b_Bar_Coverage.png")
```

## Data Processing Workflow

Data from both sources were processed in R through three main stages:

1.  Reading and cleaning monthly CSVs (removing redundant columns and correcting data types).\
2.  Validating records with confirmed measurements (`VAL` flag).\
3.  Pivoting and compressing results into `parquet` format for efficiency and consistency.

```{r fig3-pipeline, echo=FALSE, fig.align='center', out.width='90%', fig.cap='Fig. 3. Data acquisition, validation, and harmonisation workflow implemented in R.'}
knitr::include_graphics("images/Fig3_Data_Pipeline.png")
```

------------------------------------------------------------------------

# üìä Exploratory Analysis

Exploratory analysis introduces students to descriptive statistics and visual analytics in R using open environmental data.\
The focus is on **NO‚ÇÇ** (a primary traffic-related pollutant) and **O‚ÇÉ** (a secondary pollutant formed photochemically), both key indicators of urban air quality dynamics.

```{r fig4a-variability, echo=FALSE, fig.align='center', out.width='90%', fig.cap='Fig. 4. Annual variability of NO‚ÇÇ and O‚ÇÉ concentrations (2020‚Äì2024).'}
knitr::include_graphics("images/Fig4_NO2_O3_Annual_Variability.png")
```

## Annual and Seasonal Variability

```{r fig4-variability, echo=FALSE, fig.align='center', out.width='90%', fig.cap='Fig. 4. Annual variability of NO‚ÇÇ and O‚ÇÉ concentrations (2020‚Äì2024).'}
knitr::include_graphics("images/Fig4_NO2_O3_Annual_Variability.png")
```

## Distribution Analysis

Boxplots provide a powerful visual tool to discuss dispersion, central tendency, and outliers across pollutants.\
In this context, students learn how descriptive statistics translate into environmental interpretation, reinforcing quantitative reasoning with real data.

```{r fig8-boxplots, echo=FALSE, fig.align='center', out.width='90%', fig.cap='Fig. 8. Boxplots of NO‚ÇÇ and O‚ÇÉ concentrations across 2020‚Äì2024.'}
knitr::include_graphics("images/Figure8_Boxplots_NO2_O3_2020_2024.png")
```

------------------------------------------------------------------------

#üîÆ Forecasting with Prophet

Time-series forecasting introduces students to predictive modelling using open environmental data.\
The **Prophet model** (Taylor & Letham, 2018) was selected for its interpretability, decomposition structure, and robustness to missing values ‚Äî key features for teaching reproducible forecasting in R.

## Model for NO‚ÇÇ

Students can visualise how additive components ‚Äî trend, seasonality, and residuals ‚Äî reveal the influence of human activity and meteorological cycles on pollutant evolution. This exercise supports reproducible experimentation with forecasting horizons, cross-validation, and performance metrics such as RMSE or MAE.

```{r fig5a-prophet-no2, echo=FALSE, fig.align='center', out.width='90%', fig.cap='Fig. 5a. Prophet forecast for NO‚ÇÇ concentrations (2020‚Äì2024).'}
knitr::include_graphics("images/Fig5a_Prophet_NO2_F.png")
```

```{r fig5b-prophet-O3, echo=FALSE, fig.align='center', out.width='90%', fig.cap='Fig. 5b. Prophet forecast for O‚ÇÉ concentrations (2020‚Äì2024).'}
knitr::include_graphics("images/Fig5b_Prophet_O3_F.png")
```

------------------------------------------------------------------------

# üå¶ Meteorological Integration

Meteorological factors shape pollutant behaviour and are fundamental in understanding atmospheric processes.\
By integrating temperature, solar radiation, and wind speed data from **AEMET**, learners can explore multivariate relationships within an urban ecosystem.

## Integration Workflow

```{r fig7-meteo, echo=FALSE, fig.align='center', out.width='90%', fig.cap='Fig. 7. Integration workflow of meteorological and air quality data (2020‚Äì2024).'}
knitr::include_graphics("images/Fig7_Meteorological_Data_Integration_Workflow_2020_2024.png")
```

## Correlation Analysis between Pollutants and Meteorological Variables

To complement the integration workflow, this section computes the **Spearman correlations** between daily concentrations of NO‚ÇÇ and O‚ÇÉ and six meteorological parameters (temperature, relative humidity, wind speed, solar radiation, atmospheric pressure, and precipitation) using the validated datasets (2020‚Äì2024).

```{r correlation-table, echo=TRUE, message=FALSE, warning=FALSE}
## Correlation Analysis between Pollutants and Meteorological Variables

library(arrow)
library(dplyr)
library(tidyr)
library(corrr)
library(knitr)
library(purrr)
library(lubridate)

# --- 1. Cargar y combinar archivos anuales ---
air_files <- list.files("data/Calidad del Aire_Parquet",
                        pattern = "aire_validados_.*\\.parquet$", full.names = TRUE)
met_files <- list.files("data/Meteorologia_Parquet",
                        pattern = "meteo_validados_.*\\.parquet$", full.names = TRUE)

air <- map_dfr(air_files, read_parquet)
met <- map_dfr(met_files, read_parquet)

# --- 2. Crear variable diaria (solo la fecha, sin hora) ---
air <- air %>%
  mutate(date = as.Date(FECHA_HORA))  # si ya es Date, simplemente duplica la columna

met <- met %>%
  mutate(date = as.Date(FECHA_HORA))

# --- 3. Pivotar ambos datasets (formato largo ‚Üí ancho) ---
air_wide <- air %>%
  mutate(MAGNITUD = as.character(MAGNITUD)) %>%
  group_by(date, MAGNITUD) %>%
  summarise(valor = mean(VALOR, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = MAGNITUD, values_from = valor)

met_wide <- met %>%
  mutate(MAGNITUD = as.character(MAGNITUD)) %>%
  group_by(date, MAGNITUD) %>%
  summarise(valor = mean(VALOR, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = MAGNITUD, values_from = valor)

# --- 4. Unir por fecha ---
data_joined <- inner_join(air_wide, met_wide, by = "date")

# --- 5. Renombrar magnitudes seg√∫n c√≥digos del Ayuntamiento de Madrid ---
data_joined <- data_joined %>%
  rename(
    NO2 = `8`,
    O3 = `14`,
    WS = `81`,
    T = `83`,
    PRES = `85`,
    RH = `86`,
    SR = `87`,
    PREC = `89`
  )

# --- 6. Calcular correlaciones de Spearman ---
cor_matrix <- data_joined %>%
  select(NO2, O3, T, RH, WS, SR, PRES, PREC) %>%
  correlate(method = "spearman") %>%
  focus(NO2, O3) %>%
  arrange(term)

# --- 7. Mostrar tabla formateada ---
kable(round(cor_matrix, 2),
      caption = "Table 4. Spearman correlation coefficients (œÅ) between daily pollutant concentrations and meteorological variables (2020‚Äì2024).",
      col.names = c("Variable", "NO‚ÇÇ", "O‚ÇÉ"))


```

------------------------------------------------------------------------

# üéì Learning and Reproducibility Framework

Reproducibility is both a scientific and pedagogical value.\
This framework unifies open data, transparent computation, and educational innovation, reinforcing the culture of **open science**.

```{r fig6-learning, echo=FALSE, fig.align='center', out.width='90%', fig.cap='Fig. 6. Reproducible learning and open-science framework for STEM education.'}
knitr::include_graphics("images/Fig6_Learning_Reproducibility_Ecosystem.png")
```

------------------------------------------------------------------------

# üßë‚Äçüè´ Educational Applications

This Notebook can be directly incorporated into undergraduate or postgraduate STEM courses focused on data analysis, environmental informatics, or sustainability.

**Suggested learning activities:** 1. Reproduce pollutant forecasts with modified training periods.\
2. Explore correlations between additional meteorological variables.\
3. Design inquiry-based projects connecting data to local environmental policies.\
4. Document and publish reproducible reports using Quarto and GitHub.

Through these exercises, students not only practise coding but also embrace scientific integrity and civic engagement through data.

------------------------------------------------------------------------

# üåê Repository and Citation

All code, figures, and harmonised datasets are openly available at:\
<https://github.com/jcaceres-academic/OpenUrbanAirandMeteorological>

When citing this educational resource, please use:

> C√°ceres-Tello, J.; Gal√°n-Hern√°ndez, J.J. (2025). *Citizen Science and STEM Education with R: Reproducible Learning from Open Urban Air Quality Data.* *Applied Sciences*, 15(x), xxxx.\
> DOI: \[placeholder\]

This ensures traceability and recognition for open-source academic contributions.

------------------------------------------------------------------------

# üìö References

All cited works are managed through the shared bibliographic file [`applsci-3979500.bib`](../applsci-3979500.bib), which includes all references used in the manuscript and notebook.\
A public mirror of this bibliography is archived in the author‚Äôs Zotero collection:\
‚û°Ô∏è <https://www.zotero.org/jcaceres_academic/collections/X6RW9UGU>
